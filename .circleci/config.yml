version: 2.1

orbs:
  node: circleci/node@5.2.0
  rust: circleci/rust@1.6.1
  windows: circleci/windows@5.0.0
  macos: circleci/macos@2.5.1

commands:
  install-rust:
    description: "Install Rust toolchain"
    parameters:
      targets:
        type: string
        default: ""
    steps:
      - run:
          name: Install Rust
          command: |
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
            echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> $BASH_ENV
            source $BASH_ENV
            if [ -n "<< parameters.targets >>" ]; then
              rustup target add << parameters.targets >>
            fi

  build-tauri:
    description: "Build Tauri application"
    parameters:
      target:
        type: string
        default: ""
      cache-key-prefix:
        type: string
        default: "v1"
    steps:
      - restore_cache:
          name: Restore npm cache
          keys:
            - << parameters.cache-key-prefix >>-npm-{{ checksum "package-lock.json" }}
            - << parameters.cache-key-prefix >>-npm-
      - run:
          name: Install npm dependencies
          command: npm ci
      - save_cache:
          name: Save npm cache
          key: << parameters.cache-key-prefix >>-npm-{{ checksum "package-lock.json" }}
          paths:
            - node_modules
      - restore_cache:
          name: Restore Cargo cache
          keys:
            - << parameters.cache-key-prefix >>-cargo-<< parameters.target >>-{{ checksum "src-tauri/Cargo.lock" }}
            - << parameters.cache-key-prefix >>-cargo-<< parameters.target >>-
      - run:
          name: Run tests
          command: npm run test:run
      - run:
          name: Build Tauri app
          command: |
            if [ -n "<< parameters.target >>" ]; then
              npm run tauri build -- --target << parameters.target >>
            else
              npm run tauri build
            fi
          no_output_timeout: 30m
      - save_cache:
          name: Save Cargo cache
          key: << parameters.cache-key-prefix >>-cargo-<< parameters.target >>-{{ checksum "src-tauri/Cargo.lock" }}
          paths:
            - ~/.cargo/registry
            - ~/.cargo/git
            - src-tauri/target

jobs:
  build-macos-arm64:
    macos:
      xcode: "15.4.0"
    resource_class: macos.m1.medium.gen1
    steps:
      - checkout
      - node/install:
          node-version: "20"
      - install-rust:
          targets: "aarch64-apple-darwin"
      - build-tauri:
          target: "aarch64-apple-darwin"
          cache-key-prefix: "v1-macos-arm64"
      - store_artifacts:
          path: src-tauri/target/aarch64-apple-darwin/release/bundle/dmg
          destination: macos-arm64
      - persist_to_workspace:
          root: src-tauri/target/aarch64-apple-darwin/release/bundle
          paths:
            - dmg/*.dmg

  build-macos-x64:
    macos:
      xcode: "15.4.0"
    resource_class: macos.m1.medium.gen1
    steps:
      - checkout
      - node/install:
          node-version: "20"
      - install-rust:
          targets: "x86_64-apple-darwin"
      - build-tauri:
          target: "x86_64-apple-darwin"
          cache-key-prefix: "v1-macos-x64"
      - store_artifacts:
          path: src-tauri/target/x86_64-apple-darwin/release/bundle/dmg
          destination: macos-x64
      - persist_to_workspace:
          root: src-tauri/target/x86_64-apple-darwin/release/bundle
          paths:
            - dmg/*.dmg

  build-windows:
    executor:
      name: windows/default
      size: large
    steps:
      - checkout
      - run:
          name: Install Visual Studio Build Tools
          command: |
            choco install visualstudio2022buildtools --package-parameters "--add Microsoft.VisualStudio.Workload.VCTools --includeRecommended --passive --norestart" -y
          no_output_timeout: 30m
      - run:
          name: Install Node.js
          command: |
            choco install nodejs --version=20.18.0 -y
            $env:Path = "C:\Program Files\nodejs;" + [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
            node --version
            npm --version
      - run:
          name: Install Rust
          command: |
            Invoke-WebRequest -Uri https://win.rustup.rs/x86_64 -OutFile rustup-init.exe
            .\rustup-init.exe -y --default-toolchain stable-msvc
            $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
            rustup default stable-msvc
      - restore_cache:
          name: Restore npm cache
          keys:
            - v1-windows-npm-{{ checksum "package-lock.json" }}
            - v1-windows-npm-
      - run:
          name: Install npm dependencies
          command: |
            $env:Path = "C:\Program Files\nodejs;" + [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
            npm ci
      - save_cache:
          name: Save npm cache
          key: v1-windows-npm-{{ checksum "package-lock.json" }}
          paths:
            - node_modules
      - restore_cache:
          name: Restore Cargo cache
          keys:
            - v1-windows-cargo-{{ checksum "src-tauri/Cargo.lock" }}
            - v1-windows-cargo-
      - run:
          name: Run tests
          command: |
            $env:Path = "C:\Program Files\nodejs;" + [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
            npm run test:run
      - run:
          name: Build Tauri app
          command: |
            $env:Path = "C:\Program Files\nodejs;" + [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
            npm run tauri build
          no_output_timeout: 30m
      - save_cache:
          name: Save Cargo cache
          key: v1-windows-cargo-{{ checksum "src-tauri/Cargo.lock" }}
          paths:
            - C:\Users\circleci\.cargo\registry
            - C:\Users\circleci\.cargo\git
            - src-tauri\target
      - store_artifacts:
          path: src-tauri/target/release/bundle/nsis
          destination: windows
      - persist_to_workspace:
          root: src-tauri/target/release/bundle
          paths:
            - nsis/*.exe

  create-release:
    docker:
      - image: cimg/base:current
    steps:
      - attach_workspace:
          at: artifacts
      - run:
          name: List artifacts
          command: find artifacts -type f -name "*.exe" -o -name "*.dmg"
      - run:
          name: Create GitHub Release
          command: |
            if [ -n "$CIRCLE_TAG" ]; then
              echo "Creating release for tag: $CIRCLE_TAG"
              # Install GitHub CLI
              curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
              echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
              sudo apt update && sudo apt install gh -y

              # Create release
              gh release create "$CIRCLE_TAG" \
                --repo "$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME" \
                --title "$CIRCLE_TAG" \
                --draft \
                artifacts/**/*.exe \
                artifacts/**/*.dmg
            else
              echo "No tag found, skipping release creation"
            fi

workflows:
  build-and-release:
    jobs:
      - build-macos-arm64:
          filters:
            tags:
              only: /^v.*/
      - build-macos-x64:
          filters:
            tags:
              only: /^v.*/
      - build-windows:
          filters:
            tags:
              only: /^v.*/
      - create-release:
          requires:
            - build-macos-arm64
            - build-macos-x64
            - build-windows
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v.*/
